# 主从复制

主从复制是一种容错手段，为系统提供高可用性。

### 1. 两种复制方法
一般会将数据库称作状态机（State Machine），将数据库中的数据称作状态（State）。    

**状态转移（State transfer）**      
主节点将状态机的状态快照（state snapshot），也就是数据快照发送到从节点，从节点收到后加载到状态机。这是一种全量的复制方式。  
优点：简单、直接，容易保证数据正确性。   
缺点：网路开销较大，如果数据过大，同步时间会比较长。   

**复制状态机（Replicated state machine）**   
主节点将客户端操作发送到从节点，从节点收到操作后，会按相同的顺序执行这些操作。主节点执行的所有操作，从节点都会执行，最终主从节点都获得相同的状态。这是一种增量的复制方式。   

实现方式：日志。客户端操作一般会先被记录在主节点日志中，然后同步到各个从节点上。   

优点：具有更小的网络开销，只需要发送新增的操作日志。
缺点：数据一致性实现比较复杂。

这两种复制方法都有可取之处，一般在分布式系统中会结合两者特点，混合使用。   

**redis 主从同步策略**    
redis 采用的是全量与增量相结合的同步策略。   
1、从节点连接到主节点时，采用状态转移的方式，先生成快照，然后将快照分批次发送到从节点，完成全量同步；   
2、参考复制状态机的思想，在全量的基础上使用了增量复制。主节点将快照同步期间的写操作缓存下来，在快照同步完成后，将这些写操作都发送到从节点；后续的写操作同样会缓存然后发送到从节点。从节点会执行所有收到的写操作，实现增量同步。

### 2. 主从同步代码
从节点同步逻辑：  
1、连接到主节点，发送 SYNC 命令，读取快照的大小；  
2、循环读取，每次读取 1KB 数据，直到读取整个快照；  
3、清空内存数据，加载快照数据到内存中。  

```
static int syncWithMaster(void) {

}
```

主节点同步逻辑：
1、执行 SYNC 命令：检查当前是否有 bgsave 在运行，若没有，则 fork 出 bgsave 保存快照；若有，如果存在等待 bgsave 完成的其他从节点，则复制其他从节点的写操作缓存，然后等待 bgsave，否则，需要等到下一次 bgsave 启动；
2、先发送快照的大小，然后每次发送 1KB 数据，直到发送整个快照；   
3、发送快照同步期间（包括生成快照、发送快照）的所有写操作。